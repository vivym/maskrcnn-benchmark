import simplejson as json
import os
import sys

import torch

this_dir = os.path.dirname(os.path.abspath(__file__))
root_dir = os.path.abspath(os.path.join(this_dir, '..', '..'))
if root_dir not in sys.path:
    sys.path.insert(0, root_dir)


from maskrcnn_benchmark.layers import nms, soft_nms


json_data = '{"bbox": [[0.0, 302.94647216796875, 61.06944274902344, 315.9007568359375], [0.0, 307.6583251953125, 57.08546447753906, 323.81005859375], [0.0, 301.4626159667969, 60.856388092041016, 315.9987487792969], [0.63714599609375, 314.5696716308594, 49.7839241027832, 328.8766174316406], [0.0, 306.140625, 61.05177307128906, 321.72747802734375], [0.0, 335.10772705078125, 47.754371643066406, 355.67559814453125], [0.9910717010498047, 296.858642578125, 50.913238525390625, 310.54400634765625], [0.5206565856933594, 317.9685363769531, 47.73561477661133, 332.9895324707031], [0.0, 285.781005859375, 36.71613311767578, 302.77044677734375], [0.0, 287.8262939453125, 35.985015869140625, 304.2198486328125], [0.0, 302.3893737792969, 60.0531005859375, 323.7436218261719], [0.18065643310546875, 310.9217529296875, 54.075584411621094, 325.48291015625], [7.7957305908203125, 291.1524658203125, 42.13655471801758, 309.83758544921875], [2.7094974517822266, 312.37664794921875, 46.892913818359375, 331.85107421875], [0.0, 327.06903076171875, 48.53739929199219, 358.44891357421875], [13.243300437927246, 289.7401123046875, 38.62761688232422, 306.4896240234375], [1.4766120910644531, 316.1761474609375, 45.51869201660156, 335.43792724609375], [0.0, 289.4372253417969, 34.230491638183594, 303.8453674316406], [0.0, 329.4031982421875, 47.90656280517578, 357.4881591796875], [0.5515785217285156, 297.0628662109375, 50.114105224609375, 329.796875], [0.0, 333.9272766113281, 46.517173767089844, 356.1468200683594], [0.09459114074707031, 290.24444580078125, 45.94706726074219, 311.7120361328125], [0.0, 285.2417297363281, 37.58319091796875, 305.4826965332031], [0.0, 336.2369384765625, 39.41351318359375, 356.24200439453125], [0.2613983154296875, 300.02618408203125, 54.31032943725586, 330.3426513671875], [0.0, 292.1795654296875, 45.21879577636719, 319.65179443359375], [0.0, 302.4474182128906, 63.23199462890625, 315.2018127441406], [0.2951374053955078, 296.4897155761719, 53.29937744140625, 308.4236755371094]], "scores": [0.9920948147773743, 0.9698296785354614, 0.9656350612640381, 0.8021278977394104, 0.9127095937728882, 0.995602011680603, 0.3843923509120941, 0.355195552110672, 0.5542206764221191, 0.9611226320266724, 0.9977600574493408, 0.7471319437026978, 0.13146987557411194, 0.39899489283561707, 0.6542894244194031, 0.401946097612381, 0.18567967414855957, 0.3488115966320038, 0.8724080920219421, 0.5937780141830444, 0.9703628420829773, 0.4995473623275757, 0.7096364498138428, 0.12965340912342072, 0.8659764528274536, 0.1327144205570221, 0.9567065834999084, 0.1350134015083313]}'

def main():
    objs = json.loads(json_data)
    bboxes = objs['bbox']
    scores = objs['scores']
    bboxes = torch.tensor(bboxes, dtype=torch.float32)
    scores = torch.tensor(scores, dtype=torch.float32)
    print(scores)

    nmsed_bboxes = soft_nms(bboxes, scores, 0.5, 2, 0.5, 0.1)
    bboxes_ = bboxes[nmsed_bboxes]
    print(len(bboxes), '-->', len(bboxes_))
    print(bboxes_)
    print(scores)


if __name__ == '__main__':
    main()
